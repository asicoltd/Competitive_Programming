name: Daily CP Code Publisher

on:
  schedule:
    - cron: '40 7 * * *'  # Runs every day at 1:00 PM Bangladesh time
  workflow_dispatch:

jobs:
  publish-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Public Repo
        uses: actions/checkout@v3
        with:
          path: public-repo

      - name: Clone Private Repo
        uses: actions/checkout@v3
        with:
          repository: asicoltd/cp-private-dump
          token: ${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}
          path: private-repo

      - name: Copy All Files from Private to Public
        run: |
          echo "ðŸ“‚ Copying all files from private to public repo..."

          # Copy and list all copied files
          rsync -a --delete --info=NAME private-repo/ public-repo/ | tee copied_files.log

          echo "ðŸ“„ Files copied:"
          cat copied_files.log

          echo "âœ… Copy complete."

      - name: Commit and Push to Public Repo
        run: |
          cd public-repo
          git config user.name "AutoPublisher Bot"
          git config user.email "bot@github.com"
          
          # If repo has no commits, create an initial commit
          if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
            echo "No commits found. Creating initial commit..."
            git commit --allow-empty -m "Initial commit"
          fi
          
          git add .
          
          if git diff --cached --quiet; then
            echo "ðŸŸ¡ Nothing to commit."
            exit 0
          else
            git commit -m "ðŸ“¤ Auto-synced full private repo to public"
            git push
            echo "âœ… Public repo updated."
          fi
