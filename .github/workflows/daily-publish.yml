name: Daily CP Code Publisher

on:
  schedule:
    - cron: '0 7 * * *'  # Runs every day at 1:00 PM Bangladesh time
  workflow_dispatch:

jobs:
  publish-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Public Repo
        uses: actions/checkout@v3
        with:
          path: public-repo

      - name: Clone Private Repo
        uses: actions/checkout@v3
        with:
          repository: asicoltd/cp-private-dump
          token: ${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}
          path: private-repo

      - name: Find and Publish Unpublished File
        run: |
          mkdir -p public-repo/_temp
          echo "ğŸ” Scanning for unpublished code..."

          FOUND_FILE=false

          for folder in $(find private-repo -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | sort); do
            echo "ğŸ“ Checking folder: $folder"

            mkdir -p "public-repo/$folder"

            for file in $(find "private-repo/$folder" -type f | sort); do
              filename=$(basename "$file")
              dest="public-repo/$folder/$filename"

              if [ ! -f "$dest" ]; then
                echo "ğŸ†• Publishing: $filename"
                cp "$file" "$dest"
                rm "$file"
                echo "âŒ Removed from private repo: $filename"
                FOUND_FILE=true
                break 2
              fi
            done
          done

          if [ "$FOUND_FILE" = false ]; then
            echo "ğŸŸ¡ No new code found to publish. Exiting."
            exit 0
          fi

      - name: Commit and Push to Public Repo
        run: |
          cd public-repo
          git config user.name "AutoPublisher Bot"
          git config user.email "bot@github.com"
          git add .

          if git diff --cached --quiet; then
            echo "ğŸŸ¡ Nothing to commit."
            exit 0
          else
            git commit -m "ğŸ“¤ Auto-published one new CP solution from private repo"
            git push
            echo "âœ… Public repo updated."
          fi

      - name: Commit and Push to Private Repo (Remove File)
        run: |
          cd private-repo
          git config user.name "AutoPublisher Bot"
          git config user.email "bot@github.com"
          git add -u

          if git diff --cached --quiet; then
            echo "ğŸŸ¡ No deletions to commit."
            exit 0
          else
            git commit -m "ğŸ—‘ï¸ Removed published code after transfer"
            git push
            echo "âœ… Private repo cleaned up."
          fi
