name: Daily CP Code Publisher

on:
  schedule:
    - cron: '40 7 * * *'  # Every day at 1:00 PM Bangladesh time (UTC+6)
  workflow_dispatch:

jobs:
  publish-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Public Repo
        uses: actions/checkout@v3
        with:
          path: public-repo

      - name: Clone Private Repo
        uses: actions/checkout@v3
        with:
          repository: asicoltd/cp-private-dump
          token: ${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}
          path: private-repo

      - name: Clean Public Repo (Preserve .git and .github)
        run: |
          cd public-repo
          # Move critical directories to temporary location
          mv .git ../
          if [ -d .github ]; then
            mv .github ../
          fi
          # Delete everything else
          find . -mindepth 1 -delete
          # Restore critical directories
          mv ../.git .
          if [ -d ../.github ]; then
            mv ../.github .
          fi
          cd ..

      - name: Copy Files (Exclude .git and .github)
        run: |
          echo "ðŸ”„ Copying files from private to public repo..."
          rsync -a --exclude='.git' --exclude='.github' private-repo/ public-repo/
          echo "âœ… Copy complete."

      - name: Commit and Push Changes
        run: |
          cd public-repo
          git config user.name "AutoPublisher Bot"
          git config user.email "bot@github.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "ðŸ“¤ Auto-synced private repo content"
            git push
            echo "âœ… Changes pushed to public repo."
          else
            echo "ðŸŸ¡ No changes to commit."
          fi
